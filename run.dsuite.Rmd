---
title: "Run Dsuite to perform ABBA/BABA tests"
author: "Devon DeRaad"
date: '2023-01-11'
output: html_document
---

### We are going to run Dsuite to test ABBA/BABA comparisons (more info can be found at: https://github.com/millanek/Dsuite). A detailed tutorial can be found at (https://github.com/millanek/tutorials/tree/master/analysis_of_introgression_with_snp_data).

### Get input vcf
```{r}
#first thing to do is copy a filtered vcf file containing SNPs for all samples you're interested in to the working directory you're using on the cluster, e.g.
#scp -r /Users/devder/Desktop/phil.dicaeum/filtered.85.vcf d669d153@hpc.crc.ku.edu:/home/d669d153/work/phil.dicaeum/dsuite/

###NOTE: DSUITE cannot tolerate periods in input tip names or species names (must change to underscores) ###
```

### Get input sample assignments
```{r}
library(vcfR)
#we will also read in the vcf to R:
v<-read.vcfR("~/Desktop/phil.dicaeum/filtered.85.vcf")
#also read in your sample info file
pops<-read.csv("~/Desktop/phil.dicaeum/dicaeum.sampling.csv")
#it should look roughly like this:
head(pops)
#retain only samples that passed all filtering protocols (assumes that the 'ID' column is identical to sample names in the vcf)
pops<-pops[pops$ID %in% colnames(v@gt),]

#now we can make a popmap file for Dsuite
popmap<-pops[,c(1,4)]

#print popmap to screen
popmap

#we are going to manually change "nigrilore" to "Outgroup"
popmap[popmap$Taxa == "nigrilore",]<-"Outgroup"

#write out this table and copy it into your cluster working directory next to your vcf (make sure to remove column and row names)
#write.table(popmap, file="~/Downloads/dicaeum.pops.txt", sep="\t", quote=F, row.names = F, col.names=F)
```

### Get input newick tree
```{r}
#This is maybe the trickiest part, you must input a perfectly formatted newick tree showing the species tree topology for the taxa you assigned in your popmap. Use (http://etetoolkit.org/treeview/) to test whether your trees are valid and look the way you want.
#Here it is easy because there are only 4 taxa, so my tree is:
#(((zamboanga,mindanao),luzon),Outgroup);

#paste this tree into a text file named 'nwk.tre', stored in your cluster working directory
```

### We now have all three needed input files to run Dtrios and perform ABBA/BABA tests
```{bash, eval=FALSE}
##run Dtrios
##-c means this is the whole file, -n gives the name prefix for this run, -t gives the guidetree, followed by the vcf and popmap
/home/d669d153/work/Dsuite/Build/Dsuite Dtrios -c -n all.samples -t nwk.tre todi.unlinked.85.vcf pops.txt
```

### Visualize your results
```{bash, eval=FALSE}
#make a 'plot order' text file. Mine just looks like this:
Zamboanga
Mindanao
Luzon
Outgroup

##copy in ruby scripts. I already have them downloaded in another directory. 
cp /home/d669d153/work/todi.subset.2022/dsuite/plot_d.rb .
cp /home/d669d153/work/todi.subset.2022/dsuite/plot_f4ratio.rb .

#If you don't, you can download them with:
wget https://raw.githubusercontent.com/millanek/tutorials/master/analysis_of_introgression_with_snp_data/src/plot_d.rb
wget https://raw.githubusercontent.com/millanek/tutorials/master/analysis_of_introgression_with_snp_data/src/plot_f4ratio.rb

##plot heatmap of D
#the text file is an input file you generated by running Dtrios, that will always end with '_BBAA.txt'
ruby plot_d.rb pops_all.samples_BBAA.txt plot_order.txt 0.7 all.samples_BBAA_D.svg

##plot heatmap of f4
ruby plot_f4ratio.rb pops_all.samples_BBAA.txt plot_order.txt 0.2 all.samples_BBAA_f4ratio.svg

##run fbranch on the guidetree, with the Dtrios output ending in 'tree.txt' (guidetree must be rooted on #outgroup)
/home/d669d153/work/Dsuite/Build/Dsuite Fbranch todi.nwk.tre pops_all.samples_tree.txt > unlinked_Fbranch.txt

#activate python
module load python
#plot the fbranch heatmap with guidetree above
/home/d669d153/work/Dsuite/utils/dtools.py all.samples_Fbranch.txt nwk.tre
```

### check out results
```{r}
#heatmap of D
knitr::include_graphics("/Users/devder/Desktop/phil.dicaeum/dsuite/unlinked_BBAA_D.svg")

#heatmap of F4
knitr::include_graphics("/Users/devder/Desktop/phil.dicaeum/dsuite/unlinked_BBAA_f4ratio.svg")

#plot of fbranch statistic
knitr::include_graphics("/Users/devder/Desktop/phil.dicaeum/dsuite/fbranch.svg")
```

### Now we are going to repeat the above exercise with samples from Zamboanga removed
```{r}
#remove the five samples from Mt. busa from the vcf
v.nobusa<-v[,colnames(v@gt)!="D_hypoleucum_2253" & colnames(v@gt)!="D_hypoleucum_2229" & colnames(v@gt)!="D_hypoleucum_2067" & colnames(v@gt)!="D_hypoleucum_2208" & colnames(v@gt)!="D_hypoleucum_1956"]
#remove SNPs that have become invariant because of sample removal
library(SNPfiltR)
v.nobusa<-min_mac(v.nobusa, min.mac = 1)
#check vcf
v.nobusa
#write out
#vcfR::write.vcf(v.nobusa, "~/Desktop/phil.dicaeum/vcf.nomtbusa.vcf.gz")

#update the popmap
popmap<-popmap[c(popmap$ID!="D_hypoleucum_2253" & popmap$ID!="D_hypoleucum_2229" & popmap$ID!="D_hypoleucum_2067" & popmap$ID!="D_hypoleucum_2208" & popmap$ID!="D_hypoleucum_1956"),]
#write out
#write.table(popmap, file="~/Downloads/dicaeum.nomtbusa.pops.txt", sep="\t", quote=F, row.names = F, col.names=F)

#copy both of these to a subfolder eg:
#scp -r /Users/devder/Desktop/phil.dicaeum/vcf.nomtbusa.vcf d669d153@hpc.crc.ku.edu:/home/d669d153/work/phil.dicaeum/dsuite/nomtbusa/

#no need to update the tree, as the tips haven't changed, we've just removed a few samples from one of the tips
#just copy the tree file into your new subdirectory for this run
```

### We now have all three needed input files to run Dtrios and perform ABBA/BABA tests
```{bash, eval=FALSE}
##run Dtrios
##-c means this is the whole file, -n gives the name prefix for this run, -t gives the guidetree, followed by the vcf and popmap
/home/d669d153/work/Dsuite/Build/Dsuite Dtrios -c -n no.mtbusa -t nwk.tre vcf.nomtbusa.vcf pops.txt
```

### Visualize your results
```{bash, eval=FALSE}
#use the same 'plot order' text file

##copy in ruby scripts. I already have them downloaded in another directory. 
cp /home/d669d153/work/todi.subset.2022/dsuite/plot_d.rb .
cp /home/d669d153/work/todi.subset.2022/dsuite/plot_f4ratio.rb .

##plot heatmap of D
#the text file is an input file you generated by running Dtrios, that will always end with '_BBAA.txt'
ruby plot_d.rb pops_no.mtbusa_BBAA.txt plot_order.txt 0.7 no.mtbusa_BBAA_D.svg

##plot heatmap of f4
ruby plot_f4ratio.rb pops_no.mtbusa_BBAA.txt plot_order.txt 0.2 no.mtbusa_BBAA_f4ratio.svg

##run fbranch on the guidetree, with the Dtrios output ending in 'tree.txt' (guidetree must be rooted on #outgroup)
/home/d669d153/work/Dsuite/Build/Dsuite Fbranch todi.nwk.tre pops_no.mtbusa_tree.txt > unlinked_Fbranch.txt

#activate python
module load python
#plot the fbranch heatmap with guidetree above
/home/d669d153/work/Dsuite/utils/dtools.py no.mtbusa_Fbranch.txt nwk.tre
```

### check out results
```{r}
#heatmap of D
knitr::include_graphics("/Users/devder/Desktop/phil.dicaeum/dsuite/nomtbusa/unlinked_BBAA_D.svg")

#heatmap of F4
knitr::include_graphics("/Users/devder/Desktop/phil.dicaeum/dsuite/nomtbusa/unlinked_BBAA_f4ratio.svg")

#plot of fbranch statistic
knitr::include_graphics("/Users/devder/Desktop/phil.dicaeum/dsuite/nomtbusa/fbranch.svg")
```